---
- name: Get module folders
  ansible.builtin.shell:
    cmd: >-
      find {{ role_path }}/templates/*
      -type d
      -exec basename {} \;
  register: find_modules
  changed_when: false
- name: Set modules
  ansible.builtin.set_fact:
    modules: "{{ ((modules_include | length > 0) | ternary(modules_include, find_modules.stdout_lines)) | difference(modules_exclude) }}"
- name: Install modules
  with_items: "{{ modules }}"
  loop_control:
    loop_var: module
  ansible.builtin.include_tasks:
    file: module_install.yml
    apply:
      vars:
        module_name: "{{ module }}"
- name: Setup customizations
  ansible.builtin.template:
    src: customizations.nix.j2
    dest: "{{ home_manager_root }}/customizations.nix"
- name: Check if customizations already imported 
  ansible.builtin.command:
    cmd: grep --quiet '# Ansible' '{{ home_manager_root }}/home.nix'
  register: home_nix_grep
  failed_when: false
  changed_when: false
- name: Add customizations to home.nix
  when: home_nix_grep.rc != 0
  ansible.builtin.shell:
    cmd: >-
      sed --in-place 's|^}$|\n  # Ansible\n  imports = [ ./customizations.nix ];\n}|g' '{{ home_manager_root }}/home.nix'
